# Copyright 2026 icecake0141
# SPDX-License-Identifier: Apache-2.0
#
# This file was created or modified with the assistance of an AI (Large Language Model).
# Please review for correctness and security.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0

name: CI

on:
  push:
    branches: [ main, develop, copilot/** ]
    paths-ignore:
      - '*.md'
      - '**/*.md'
      - 'docs/**'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '*.md'
      - '**/*.md'
      - 'docs/**'

# Cancel superseded runs on the same PR or branch to avoid wasted minutes.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'backend/requirements-dev.txt'

    - name: Install dependencies
      run: pip install -r backend/requirements-dev.txt

    - name: Run black
      run: black --check backend/app backend_v2/app tests backend_v2/tests

    - name: Run flake8
      run: flake8 backend/app backend_v2/app tests backend_v2/tests --max-line-length=120 --extend-ignore=E203,W503

    - name: Run mypy (backend_v2)
      run: mypy --explicit-package-bases backend_v2/app

    - name: Run py_compile smoke check
      run: |
        PYTHONPYCACHEPREFIX=.pycache python -m py_compile \
          backend/app/main.py \
          backend/app/models.py \
          backend/app/ssh_executor.py \
          backend/app/job_manager.py \
          backend/app/ws.py \
          backend_v2/app/api/main.py \
          backend_v2/app/application/execution_engine.py

  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'backend/requirements-dev.txt'

    - name: Install dependencies
      run: pip install -r backend/requirements-dev.txt

    - name: Run unit tests
      run: pytest tests/unit backend_v2/tests/unit -v --cov=backend/app --cov=backend_v2/app --cov-report=xml --cov-report=term

    - name: Upload coverage
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: coverage-report
        path: coverage.xml
        retention-days: 7

  # Docker build and integration tests are expensive; run only on pushes to
  # main/develop (i.e. after merge), not on every PR or feature-branch push.
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
    - uses: actions/checkout@v6

    - name: Build Docker image
      run: docker build -t nw-edit:latest .

    - name: Test Docker image
      run: docker run --rm nw-edit:latest python -c "import app.main; print('OK')"

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'backend/requirements-dev.txt'

    - name: Install dependencies
      run: pip install -r backend/requirements-dev.txt

    - name: Start mock SSH server
      run: |
        docker compose --profile test up -d mock-ssh
        sleep 10

    - name: Run integration tests
      run: pytest tests/integration backend_v2/tests/integration -v -m integration

    - name: Stop services
      if: always()
      run: docker compose --profile test down
